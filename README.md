# CommunicationMod
Slay the Spire mod that provides a protocol for allowing another process to control the game

## Requirements

- Slay the Spire
- ModTheSpire (https://github.com/kiooeht/ModTheSpire)
- BaseMod (https://github.com/daviscook477/BaseMod)

## Setup

1. Copy CommunicationMod.jar to your ModTheSpire mods directory
2. Run ModTheSpire with CommunicationMod enabled
3. Edit your newly-created SpireConfig file with the command you want to use with CommunicationMod (see https://github.com/kiooeht/ModTheSpire/wiki/SpireConfig for the location of your config file). Your config file should look something like this (note that certain special characters must be escaped):
```
#Sat Apr 20 02:49:10 CDT 2019
command=python C\:\\Path\\To\\Script\\main.py
```

## What does this mod do?

CommunicationMod launches a specified process and communicates with this process through stdin and stdout, with the following protocol:

(Note: all messages are assumed to be ended by a new line '\n')

- After starting the external process, CommunicationMod waits for the process to send "ready" on stdout. If "ready" is not received before a specified timeout, the external process will be terminated.
- Whenever the state of the game is determined to be stable (no longer changing without external input), CommunicationMod sends a message containing the JSON representation of the current game state to the external process's stdin. For example:
```
{"available_commands":["play","end","state"],"ready_for_command":true,"in_game":true,"game_state":{"screen_type":"NONE","screen_state":{},"seed":-7475059281641056729,"combat_state":{"draw_pile":[{"exhausts":false,"is_playable":true,"cost":1,"name":"Strike","id":"Strike_G","type":"ATTACK","uuid":"b7105dcd-55ee-4e5f-9656-e293da05dc1d","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"is_playable":true,"cost":0,"name":"Neutralize+","id":"Neutralize","type":"ATTACK","uuid":"f41383b8-3d95-4207-9f93-e215f4f2260e","upgrades":1,"rarity":"BASIC","has_target":true},{"exhausts":false,"is_playable":true,"cost":1,"name":"Defend","id":"Defend_G","type":"SKILL","uuid":"50f59a59-4168-4664-8fe6-7f6831b1c878","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":true,"cost":1,"name":"Backflip","id":"Backflip","type":"SKILL","uuid":"acc70e74-9afc-40fc-b4bf-1c6fbbee6b63","upgrades":0,"rarity":"COMMON","has_target":false}],"discard_pile":[{"exhausts":false,"is_playable":true,"cost":1,"name":"Glass Knife","id":"Glass Knife","type":"ATTACK","uuid":"29f6cff8-97f1-4556-bc25-a6c4136c2155","upgrades":0,"rarity":"RARE","has_target":true},{"exhausts":false,"is_playable":true,"cost":1,"name":"Deadly Poison","id":"Deadly Poison","type":"SKILL","uuid":"33501d0e-d389-43f1-88c7-7bff8cbc82a6","upgrades":0,"rarity":"COMMON","has_target":true},{"exhausts":false,"is_playable":true,"cost":1,"name":"Defend","id":"Defend_G","type":"SKILL","uuid":"9393b3be-a550-4925-a562-92778cc6bf57","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":true,"cost":1,"name":"Survivor","id":"Survivor","type":"SKILL","uuid":"81b76251-ffbc-456c-9a80-826ca159eab8","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":true,"cost":1,"name":"Defend","id":"Defend_G","type":"SKILL","uuid":"6334d652-ccab-4c9d-8c1c-4333ce0075f7","upgrades":0,"rarity":"BASIC","has_target":false}],"exhaust_pile":[{"exhausts":true,"is_playable":true,"cost":-1,"name":"Malaise","id":"Malaise","type":"SKILL","uuid":"89af7de5-2b49-44b5-b6c6-9c17076dcc15","upgrades":0,"rarity":"RARE","has_target":true},{"exhausts":true,"is_playable":true,"cost":0,"name":"Adrenaline+","id":"Adrenaline","type":"SKILL","uuid":"a7d9aa47-cd3c-413d-aade-e65905d1aa1d","upgrades":1,"rarity":"RARE","has_target":false},{"exhausts":true,"is_playable":true,"cost":0,"name":"Shiv","id":"Shiv","type":"ATTACK","uuid":"b9ef472a-b688-4718-8cbe-3131510e29cd","upgrades":0,"rarity":"SPECIAL","has_target":true}],"monsters":[{"is_gone":false,"move_hits":5,"move_base_damage":1,"half_dead":false,"move_adjusted_damage":0,"max_hp":28,"intent":"ATTACK","move_id":1,"name":"Byrd","current_hp":20,"block":0,"id":"Byrd","powers":[{"amount":-3,"name":"Strength","id":"Strength"},{"amount":10,"name":"Poison","id":"Poison"},{"amount":3,"name":"Flight","id":"Flight"},{"amount":1,"name":"Weakened","id":"Weakened"}]},{"is_gone":true,"move_hits":1,"move_base_damage":3,"half_dead":false,"move_adjusted_damage":3,"max_hp":26,"intent":"ATTACK","move_id":5,"name":"Byrd","current_hp":0,"block":0,"id":"Byrd","powers":[]},{"is_gone":false,"move_hits":5,"move_base_damage":1,"half_dead":false,"move_adjusted_damage":3,"max_hp":27,"intent":"ATTACK","move_id":1,"name":"Byrd","current_hp":16,"block":0,"id":"Byrd","powers":[{"amount":2,"name":"Strength","id":"Strength"},{"amount":5,"name":"Poison","id":"Poison"},{"amount":3,"name":"Flight","id":"Flight"}]}],"hand":[{"exhausts":false,"is_playable":true,"cost":1,"name":"Strike","id":"Strike_G","type":"ATTACK","uuid":"81c5295b-0355-4fb4-8b3d-69c6cc9473a0","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"is_playable":true,"cost":1,"name":"Cloak and Dagger","id":"Cloak And Dagger","type":"SKILL","uuid":"ea6f267d-0271-4665-9354-4dd15207949a","upgrades":0,"rarity":"COMMON","has_target":false},{"exhausts":false,"is_playable":true,"cost":1,"name":"Defend","id":"Defend_G","type":"SKILL","uuid":"2a164959-d66e-4a84-b57e-1d9a1400c8e1","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":true,"cost":1,"name":"Backflip","id":"Backflip","type":"SKILL","uuid":"9bbf803d-acdc-4f9d-a168-f5d4359ee91e","upgrades":0,"rarity":"COMMON","has_target":false},{"exhausts":false,"is_playable":true,"cost":1,"name":"Defend","id":"Defend_G","type":"SKILL","uuid":"524d5e7a-c56f-4f04-adb0-9df2e259cba9","upgrades":0,"rarity":"BASIC","has_target":false}],"player":{"current_hp":48,"block":0,"max_hp":80,"powers":[{"amount":3,"name":"Noxious Fumes","id":"Noxious Fumes"}],"energy":4}},"deck":[{"exhausts":false,"is_playable":true,"cost":1,"name":"Defend","id":"Defend_G","type":"SKILL","uuid":"524d5e7a-c56f-4f04-adb0-9df2e259cba9","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":true,"cost":1,"name":"Defend","id":"Defend_G","type":"SKILL","uuid":"2a164959-d66e-4a84-b57e-1d9a1400c8e1","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":true,"cost":1,"name":"Defend","id":"Defend_G","type":"SKILL","uuid":"50f59a59-4168-4664-8fe6-7f6831b1c878","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":true,"cost":1,"name":"Defend","id":"Defend_G","type":"SKILL","uuid":"6334d652-ccab-4c9d-8c1c-4333ce0075f7","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":true,"cost":1,"name":"Defend","id":"Defend_G","type":"SKILL","uuid":"9393b3be-a550-4925-a562-92778cc6bf57","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":true,"cost":1,"name":"Strike","id":"Strike_G","type":"ATTACK","uuid":"b7105dcd-55ee-4e5f-9656-e293da05dc1d","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"is_playable":true,"cost":1,"name":"Strike","id":"Strike_G","type":"ATTACK","uuid":"81c5295b-0355-4fb4-8b3d-69c6cc9473a0","upgrades":0,"rarity":"BASIC","has_target":true},{"exhausts":false,"is_playable":true,"cost":1,"name":"Survivor","id":"Survivor","type":"SKILL","uuid":"81b76251-ffbc-456c-9a80-826ca159eab8","upgrades":0,"rarity":"BASIC","has_target":false},{"exhausts":false,"is_playable":true,"cost":0,"name":"Neutralize+","id":"Neutralize","type":"ATTACK","uuid":"f41383b8-3d95-4207-9f93-e215f4f2260e","upgrades":1,"rarity":"BASIC","has_target":true},{"exhausts":true,"is_playable":true,"cost":0,"name":"Adrenaline+","id":"Adrenaline","type":"SKILL","uuid":"a7d9aa47-cd3c-413d-aade-e65905d1aa1d","upgrades":1,"rarity":"RARE","has_target":false},{"exhausts":false,"is_playable":true,"cost":1,"name":"Backflip","id":"Backflip","type":"SKILL","uuid":"9bbf803d-acdc-4f9d-a168-f5d4359ee91e","upgrades":0,"rarity":"COMMON","has_target":false},{"exhausts":false,"is_playable":true,"cost":1,"name":"Glass Knife","id":"Glass Knife","type":"ATTACK","uuid":"29f6cff8-97f1-4556-bc25-a6c4136c2155","upgrades":0,"rarity":"RARE","has_target":true},{"exhausts":false,"is_playable":true,"cost":1,"name":"Cloak and Dagger","id":"Cloak And Dagger","type":"SKILL","uuid":"ea6f267d-0271-4665-9354-4dd15207949a","upgrades":0,"rarity":"COMMON","has_target":false},{"exhausts":false,"is_playable":true,"cost":1,"name":"Deadly Poison","id":"Deadly Poison","type":"SKILL","uuid":"33501d0e-d389-43f1-88c7-7bff8cbc82a6","upgrades":0,"rarity":"COMMON","has_target":true},{"exhausts":false,"is_playable":true,"cost":1,"name":"Backflip","id":"Backflip","type":"SKILL","uuid":"acc70e74-9afc-40fc-b4bf-1c6fbbee6b63","upgrades":0,"rarity":"COMMON","has_target":false},{"exhausts":false,"is_playable":true,"cost":1,"name":"Noxious Fumes+","id":"Noxious Fumes","type":"POWER","uuid":"4a5583a8-60fd-4ab9-ae58-e12fd7fe8282","upgrades":1,"rarity":"UNCOMMON","has_target":false},{"exhausts":true,"is_playable":true,"cost":-1,"name":"Malaise","id":"Malaise","type":"SKILL","uuid":"89af7de5-2b49-44b5-b6c6-9c17076dcc15","upgrades":0,"rarity":"RARE","has_target":true}],"relics":[{"name":"Ring of the Snake","id":"Ring of the Snake","counter":-1},{"name":"Happy Flower","id":"Happy Flower","counter":0},{"name":"Pear","id":"Pear","counter":-1},{"name":"Centennial Puzzle","id":"Centennial Puzzle","counter":-1},{"name":"Meat on the Bone","id":"Meat on the Bone","counter":-1},{"name":"Philosopher\u0027s Stone","id":"Philosopher\u0027s Stone","counter":-1}],"max_hp":80,"gold":178,"action_phase":"WAITING_ON_USER","act":2,"screen_name":"NONE","room_phase":"COMBAT","is_screen_up":false,"potions":[{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"},{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"},{"requires_target":false,"can_use":false,"can_discard":false,"name":"Potion Slot","id":"Potion Slot"}],"current_hp":48,"floor":19,"ascension_level":0,"class":"THE_SILENT","map":[{"symbol":"M","children":[{"x":1,"y":1}],"x":1,"y":0,"parents":[]},{"symbol":"M","children":[{"x":4,"y":1}],"x":3,"y":0,"parents":[]},{"symbol":"M","children":[{"x":5,"y":1}],"x":4,"y":0,"parents":[]},{"symbol":"M","children":[{"x":6,"y":1}],"x":6,"y":0,"parents":[]},{"symbol":"M","children":[{"x":0,"y":2}],"x":1,"y":1,"parents":[]},{"symbol":"M","children":[{"x":3,"y":2}],"x":4,"y":1,"parents":[]},{"symbol":"M","children":[{"x":4,"y":2},{"x":6,"y":2}],"x":5,"y":1,"parents":[]},{"symbol":"M","children":[{"x":6,"y":2}],"x":6,"y":1,"parents":[]},{"symbol":"?","children":[{"x":0,"y":3}],"x":0,"y":2,"parents":[]},{"symbol":"M","children":[{"x":3,"y":3}],"x":3,"y":2,"parents":[]},{"symbol":"M","children":[{"x":3,"y":3}],"x":4,"y":2,"parents":[]},{"symbol":"?","children":[{"x":6,"y":3}],"x":6,"y":2,"parents":[]},{"symbol":"M","children":[{"x":1,"y":4}],"x":0,"y":3,"parents":[]},{"symbol":"M","children":[{"x":2,"y":4},{"x":3,"y":4}],"x":3,"y":3,"parents":[]},{"symbol":"M","children":[{"x":5,"y":4},{"x":6,"y":4}],"x":6,"y":3,"parents":[]},{"symbol":"M","children":[{"x":0,"y":5}],"x":1,"y":4,"parents":[]},{"symbol":"?","children":[{"x":2,"y":5},{"x":3,"y":5}],"x":2,"y":4,"parents":[]},{"symbol":"M","children":[{"x":4,"y":5}],"x":3,"y":4,"parents":[]},{"symbol":"?","children":[{"x":4,"y":5}],"x":5,"y":4,"parents":[]},{"symbol":"$","children":[{"x":6,"y":5}],"x":6,"y":4,"parents":[]},{"symbol":"R","children":[{"x":1,"y":6}],"x":0,"y":5,"parents":[]},{"symbol":"R","children":[{"x":3,"y":6}],"x":2,"y":5,"parents":[]},{"symbol":"E","children":[{"x":4,"y":6}],"x":3,"y":5,"parents":[]},{"symbol":"R","children":[{"x":4,"y":6},{"x":5,"y":6}],"x":4,"y":5,"parents":[]},{"symbol":"E","children":[{"x":6,"y":6}],"x":6,"y":5,"parents":[]},{"symbol":"?","children":[{"x":1,"y":7}],"x":1,"y":6,"parents":[]},{"symbol":"M","children":[{"x":3,"y":7}],"x":3,"y":6,"parents":[]},{"symbol":"M","children":[{"x":3,"y":7},{"x":4,"y":7}],"x":4,"y":6,"parents":[]},{"symbol":"?","children":[{"x":5,"y":7}],"x":5,"y":6,"parents":[]},{"symbol":"M","children":[{"x":6,"y":7}],"x":6,"y":6,"parents":[]},{"symbol":"R","children":[{"x":0,"y":8}],"x":1,"y":7,"parents":[]},{"symbol":"?","children":[{"x":3,"y":8},{"x":4,"y":8}],"x":3,"y":7,"parents":[]},{"symbol":"R","children":[{"x":4,"y":8}],"x":4,"y":7,"parents":[]},{"symbol":"?","children":[{"x":6,"y":8}],"x":5,"y":7,"parents":[]},{"symbol":"M","children":[{"x":6,"y":8}],"x":6,"y":7,"parents":[]},{"symbol":"T","children":[{"x":0,"y":9}],"x":0,"y":8,"parents":[]},{"symbol":"T","children":[{"x":3,"y":9}],"x":3,"y":8,"parents":[]},{"symbol":"T","children":[{"x":5,"y":9}],"x":4,"y":8,"parents":[]},{"symbol":"T","children":[{"x":5,"y":9},{"x":6,"y":9}],"x":6,"y":8,"parents":[]},{"symbol":"M","children":[{"x":1,"y":10}],"x":0,"y":9,"parents":[]},{"symbol":"$","children":[{"x":4,"y":10}],"x":3,"y":9,"parents":[]},{"symbol":"?","children":[{"x":5,"y":10}],"x":5,"y":9,"parents":[]},{"symbol":"M","children":[{"x":5,"y":10}],"x":6,"y":9,"parents":[]},{"symbol":"?","children":[{"x":2,"y":11}],"x":1,"y":10,"parents":[]},{"symbol":"R","children":[{"x":4,"y":11}],"x":4,"y":10,"parents":[]},{"symbol":"?","children":[{"x":4,"y":11},{"x":5,"y":11},{"x":6,"y":11}],"x":5,"y":10,"parents":[]},{"symbol":"M","children":[{"x":3,"y":12}],"x":2,"y":11,"parents":[]},{"symbol":"M","children":[{"x":3,"y":12},{"x":4,"y":12}],"x":4,"y":11,"parents":[]},{"symbol":"E","children":[{"x":4,"y":12},{"x":6,"y":12}],"x":5,"y":11,"parents":[]},{"symbol":"R","children":[{"x":6,"y":12}],"x":6,"y":11,"parents":[]},{"symbol":"M","children":[{"x":2,"y":13},{"x":3,"y":13}],"x":3,"y":12,"parents":[]},{"symbol":"$","children":[{"x":3,"y":13},{"x":5,"y":13}],"x":4,"y":12,"parents":[]},{"symbol":"M","children":[{"x":5,"y":13},{"x":6,"y":13}],"x":6,"y":12,"parents":[]},{"symbol":"M","children":[{"x":3,"y":14}],"x":2,"y":13,"parents":[]},{"symbol":"E","children":[{"x":3,"y":14}],"x":3,"y":13,"parents":[]},{"symbol":"M","children":[{"x":6,"y":14}],"x":5,"y":13,"parents":[]},{"symbol":"?","children":[{"x":6,"y":14}],"x":6,"y":13,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":3,"y":14,"parents":[]},{"symbol":"R","children":[{"x":3,"y":16}],"x":6,"y":14,"parents":[]}],"room_type":"MonsterRoom"}}
```
- CommunicationMod then waits for a message back from the external process, containing a command to be executed. Possible commands are:
  - START PlayerClass [AscensionLevel] [Seed]
    - Starts a new game with the selected class, on the selected Ascension level (default 0), with the selected seed (random seed if omitted).
    - Seeds are alphanumeric, as displayed in game.
    - This and all commands are case insensitive.
    - Only currently available in the main menu of the game.
  - POTION Use|Discard PotionSlot [TargetIndex]
    - Uses or discards the potion in the selected slot, on the selected target, if necessary.
    - TargetIndex is the index of the target monster in the game's monster array (0-indexed).
    - Only available when potions can be used or discarded.
  - PLAY CardIndex [TargetIndex]
    - Plays the selected card in your hand, with the selected target, if necessary.
    - Only available when cards can be played in combat.
    - Currently, CardIndex is 1-indexed to match up with the card numbers in game.
  - END
    - Ends your turn.
    - Only available when the end turn button is available, in combat.
  - CHOOSE ChoiceIndex|ChoiceName
    - Makes a choice relevant to the current screen.
    - A list of names for each choice is provided in the game state. If provided with a name, the first choice index with the matching name is selected.
    - Generally, available at any point when PLAY is not available.
  - PROCEED
    - Clicks the button on the right side of the screen, generally causing the game to proceed to a new screen.
    - Equivalent to CONFIRM.
    - Available whenever the proceed or confirm button is present on the right side of the screen.
  - RETURN
    - Clicks the button on the left side of the screen, generally causing you to return to the previous screen.
    - Equivalent to SKIP, CANCEL, and LEAVE.
    - Available whenever the return, cancel, or leave buttons are present on the left side of the screen. Also used for the skip button on card reward screens.
  - STATE
    - Causes CommunicationMod to immediately send a JSON representation of the current state to the external process, whether or not the game state is stable.
    - Always available.
- Upon receiving a command, CommunicationMod will execute it, and reply again with a JSON representation of the state of the game, when it is next stable.
- If there was an error in executing the command, CommunicationMod will instead send an error message of the form:
```
{"error":"Error message","ready_for_command":True}
```

## Known issues and limitations, to be hopefully fixed soon:
- The full state of the Match and Keep event is not transmitted.
- There is no feedback or state change if you attempt to take or buy a potion while your potion inventory is full. Beware!
- Very rarely, the game will fail to execute a choose action and will get stuck. I have tried to fix as many of these as possible, but have observed it happening in some events.
- Unselecting cards in hand select screens is not supported.
- Several actions do not currently register a state change if they are performed manually in game.
- You must manually edit the mod's config file to set the command for your external process.
- This mod has only been tested on Windows 10 at this point.

## What are some of the potential applications of this mod?

- Twitch plays Slay the Spire
- Slay the Spire AIs
- Streamers can display detailed information about the current run while in game
